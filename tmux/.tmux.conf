# --- 기본 설정 ---
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*:Tc"

# 새 창/팬에서 실행할 셸 (bash에서 tmux를 띄워도 새 창은 zsh)
set -g default-shell /usr/bin/zsh
set -g default-command "exec /usr/bin/zsh -l"

# 터미널 한글/UTF-8: 새 팬에서 로케일·IME 환경 변수 상속
set -g update-environment "LANG LC_ALL LC_CTYPE GTK_IM_MODULE QT_IM_MODULE XMODIFIERS"

set -g prefix C-a
unbind C-b
bind C-a send-prefix

set -g mouse on
setw -g mode-keys vi
set -g status-keys vi
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g status-interval 1
set -g history-limit 100000
set -g repeat-time 0
set -g set-titles on
set -g set-titles-string "#S #I:#W (#h)"
set -g message-style "fg=white,bg=#0087af"
set -g message-command-style "fg=white,bg=#0087af"

# 설정 다시 로드 (Ctrl+a r) — 실행 사용자 홈 기준 (dev 등 별도 사용자에서도 동작)
bind r source-file $HOME/.tmux.conf \; display "Reloaded $HOME/.tmux.conf"

# --- 팬 분할 ---
# 직관적인 분할 키 (| 와 - 는 반드시 따옴표로 감싸야 tmux가 파이프로 오해하지 않음)
bind "|" split-window -h -c "#{pane_current_path}"
bind "-" split-window -v -c "#{pane_current_path}"
# v/s 로도 분할
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"

# --- 팬 이동 (vi 스타일) ---
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind q display-panes

# --- 팬 크기 조절 ---
bind ">" resize-pane -R 10
bind "<" resize-pane -L 10
bind "+" resize-pane -D 5
bind "_" resize-pane -U 5

# --- 창 이동/관리 ---
bind Left previous-window
bind Right next-window
bind BSpace previous-window
bind S-Left swap-window -t :-
bind S-Right swap-window -t :+
bind "%" command-prompt -I "#I" "move-window -t '%%'"
bind "/" command-prompt "move-window -t '%%'"
bind A command-prompt -I "#W" "rename-window '%%'"

# --- 복사/붙여넣기 ---
bind Enter copy-mode
bind Escape copy-mode
bind L clear-history
bind p run-shell "pbpaste | tmux load-buffer - && tmux paste-buffer"

# --- Synchronize panes (팬 동기화) ---
bind e if-shell -F "#{pane_synchronized}" \
  "setw synchronize-panes off; \
   setw pane-border-style fg=colour240; \
   setw pane-active-border-style fg=green,bg=default;" \
  "setw synchronize-panes on; \
   setw pane-border-style fg=colour226; \
   setw pane-active-border-style fg=colour202,bg=default;"
bind y set-window-option synchronize-panes

# --- ★ 핵심: 중첩 Tmux 제어 (F12) ★ ---
# F12를 누르면 로컬 Tmux의 키 입력을 비활성화하여
# 안쪽(원격/도커) Tmux로 키를 전달합니다.
bind -T root F12  \
  set prefix None \;\
  set key-table off \;\
  set status-style "fg=colour245,bg=colour238" \;\
  if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
  refresh-client -S \;\

bind -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  set -u status-style \;\
  refresh-client -S

# --- 상태바: 동적 스크립트 (CPU, RAM, GPU, NPU) ---
# 실행 사용자 홈 기준 (dev 등 별도 사용자에서도 동작)
set -g status-position bottom
set -g status-style "bg=#1c1c1c,none"
set -g status-justify left
set -g status-left-length 100
set -g status-right-length 100
# 초기 표시 후 statusbar.tmux 가 덮어씀
set -g status-right "#[bg=colour228,fg=black]Loading...#[default]"
run-shell "$HOME/.tmux/statusbar.tmux 2>/dev/null"

# statusbar 스크립트가 없을 때를 위한 기본 상태바
setw -g window-status-current-format "#[fg=black,bg=green,bold] #I:#W #[default]"
setw -g window-status-format "#[fg=white,bg=#1c1c1c] #I:#W "

# --- 플러그인 (TPM) ---
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'nhdaly/tmux-scroll-copy-mode'
set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'laktak/extrakto'

# TPM 초기화 (반드시 맨 아래에 위치)
run '~/.tmux/plugins/tpm/tpm'
